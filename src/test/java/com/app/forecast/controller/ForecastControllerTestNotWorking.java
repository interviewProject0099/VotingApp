package com.app.forecast.controller;

import com.app.forecast.apiclient.ForecastWebClient;
import com.app.forecast.service.ForecastService;
import com.github.tomakehurst.wiremock.client.WireMock;
import com.github.tomakehurst.wiremock.junit5.WireMockExtension;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.RegisterExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;

import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;
import static com.github.tomakehurst.wiremock.core.WireMockConfiguration.wireMockConfig;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
public class ForecastControllerTestNotWorking {

    public static final String LATITUDE = "12.34";
    public static final String LONGITUDE = "56.78";
    public static final String API_BASE_URL = "https://archive-api.open-meteo.com/v1/archive";

    @Autowired
    protected MockMvc mockMvc;

    @RegisterExtension
    static WireMockExtension wireMockServer = WireMockExtension.newInstance()
            .options(wireMockConfig().dynamicPort())
            .build();

    @MockBean
    private ForecastService forecastServiceMock;
    @MockBean
    ForecastWebClient forecastWebClientMock;

    @Test
    void shouldReturnForecastByCoordinates() throws Exception {
        //given
        wireMockServer.stubFor(WireMock.get(WireMock.urlMatching(API_BASE_URL + ".*"))
                .willReturn(
                        aResponse()
                                .withHeader("Content-Type", MediaType.APPLICATION_JSON_VALUE)
                                .withBody(createForecastResponse())));

        // when
        mockMvc.perform(MockMvcRequestBuilders.get("/forecast/v1/last-week")
                        .param("latitude", LATITUDE)
                        .param("longitude", LONGITUDE)
                        .contentType(MediaType.APPLICATION_JSON))

                //then
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.locationInfoParDayList").isArray());
    }

    private String createForecastResponse() {

        return """
                {
                "latitude": -52.5,
                "longitude": 13.400009,
                "generationtime_ms": 0.32806396484375,
                "utc_offset_seconds": 3600,
                "timezone": "Etc/GMT-1",
                "timezone_abbreviation": "+01",
                "elevation": 0,
                "hourly_units": {
                "time": "iso8601",
                "precipitation": "mm"
                },
                "hourly": {
                "time": [
                "2023-05-08T00:00",
                "2023-05-08T01:00",
                "2023-05-08T02:00",
                "2023-05-08T03:00",
                "2023-05-08T04:00",
                "2023-05-08T05:00",
                "2023-05-08T06:00",
                "2023-05-08T07:00",
                "2023-05-08T08:00",
                "2023-05-08T09:00",
                "2023-05-08T10:00",
                "2023-05-08T11:00",
                "2023-05-08T12:00",
                "2023-05-08T13:00",
                "2023-05-08T14:00",
                "2023-05-08T15:00",
                "2023-05-08T16:00",
                "2023-05-08T17:00",
                "2023-05-08T18:00",
                "2023-05-08T19:00",
                "2023-05-08T20:00",
                "2023-05-08T21:00",
                "2023-05-08T22:00",
                "2023-05-08T23:00",
                "2023-05-09T00:00",
                "2023-05-09T01:00",
                "2023-05-09T02:00",
                "2023-05-09T03:00",
                "2023-05-09T04:00",
                "2023-05-09T05:00",
                "2023-05-09T06:00",
                "2023-05-09T07:00",
                "2023-05-09T08:00",
                "2023-05-09T09:00",
                "2023-05-09T10:00",
                "2023-05-09T11:00",
                "2023-05-09T12:00",
                "2023-05-09T13:00",
                "2023-05-09T14:00",
                "2023-05-09T15:00",
                "2023-05-09T16:00",
                "2023-05-09T17:00",
                "2023-05-09T18:00",
                "2023-05-09T19:00",
                "2023-05-09T20:00",
                "2023-05-09T21:00",
                "2023-05-09T22:00",
                "2023-05-09T23:00",
                "2023-05-10T00:00",
                "2023-05-10T01:00",
                "2023-05-10T02:00",
                "2023-05-10T03:00",
                "2023-05-10T04:00",
                "2023-05-10T05:00",
                "2023-05-10T06:00",
                "2023-05-10T07:00",
                "2023-05-10T08:00",
                "2023-05-10T09:00",
                "2023-05-10T10:00",
                "2023-05-10T11:00",
                "2023-05-10T12:00",
                "2023-05-10T13:00",
                "2023-05-10T14:00",
                "2023-05-10T15:00",
                "2023-05-10T16:00",
                "2023-05-10T17:00",
                "2023-05-10T18:00",
                "2023-05-10T19:00",
                "2023-05-10T20:00",
                "2023-05-10T21:00",
                "2023-05-10T22:00",
                "2023-05-10T23:00",
                "2023-05-11T00:00",
                "2023-05-11T01:00",
                "2023-05-11T02:00",
                "2023-05-11T03:00",
                "2023-05-11T04:00",
                "2023-05-11T05:00",
                "2023-05-11T06:00",
                "2023-05-11T07:00",
                "2023-05-11T08:00",
                "2023-05-11T09:00",
                "2023-05-11T10:00",
                "2023-05-11T11:00",
                "2023-05-11T12:00",
                "2023-05-11T13:00",
                "2023-05-11T14:00",
                "2023-05-11T15:00",
                "2023-05-11T16:00",
                "2023-05-11T17:00",
                "2023-05-11T18:00",
                "2023-05-11T19:00",
                "2023-05-11T20:00",
                "2023-05-11T21:00",
                "2023-05-11T22:00",
                "2023-05-11T23:00",
                "2023-05-12T00:00",
                "2023-05-12T01:00",
                "2023-05-12T02:00",
                "2023-05-12T03:00",
                "2023-05-12T04:00",
                "2023-05-12T05:00",
                "2023-05-12T06:00",
                "2023-05-12T07:00",
                "2023-05-12T08:00",
                "2023-05-12T09:00",
                "2023-05-12T10:00",
                "2023-05-12T11:00",
                "2023-05-12T12:00",
                "2023-05-12T13:00",
                "2023-05-12T14:00",
                "2023-05-12T15:00",
                "2023-05-12T16:00",
                "2023-05-12T17:00",
                "2023-05-12T18:00",
                "2023-05-12T19:00",
                "2023-05-12T20:00",
                "2023-05-12T21:00",
                "2023-05-12T22:00",
                "2023-05-12T23:00",
                "2023-05-13T00:00",
                "2023-05-13T01:00",
                "2023-05-13T02:00",
                "2023-05-13T03:00",
                "2023-05-13T04:00",
                "2023-05-13T05:00",
                "2023-05-13T06:00",
                "2023-05-13T07:00",
                "2023-05-13T08:00",
                "2023-05-13T09:00",
                "2023-05-13T10:00",
                "2023-05-13T11:00",
                "2023-05-13T12:00",
                "2023-05-13T13:00",
                "2023-05-13T14:00",
                "2023-05-13T15:00",
                "2023-05-13T16:00",
                "2023-05-13T17:00",
                "2023-05-13T18:00",
                "2023-05-13T19:00",
                "2023-05-13T20:00",
                "2023-05-13T21:00",
                "2023-05-13T22:00",
                "2023-05-13T23:00",
                "2023-05-14T00:00",
                "2023-05-14T01:00",
                "2023-05-14T02:00",
                "2023-05-14T03:00",
                "2023-05-14T04:00",
                "2023-05-14T05:00",
                "2023-05-14T06:00",
                "2023-05-14T07:00",
                "2023-05-14T08:00",
                "2023-05-14T09:00",
                "2023-05-14T10:00",
                "2023-05-14T11:00",
                "2023-05-14T12:00",
                "2023-05-14T13:00",
                "2023-05-14T14:00",
                "2023-05-14T15:00",
                "2023-05-14T16:00",
                "2023-05-14T17:00",
                "2023-05-14T18:00",
                "2023-05-14T19:00",
                "2023-05-14T20:00",
                "2023-05-14T21:00",
                "2023-05-14T22:00",
                "2023-05-14T23:00",
                "2023-05-15T00:00",
                "2023-05-15T01:00",
                "2023-05-15T02:00",
                "2023-05-15T03:00",
                "2023-05-15T04:00",
                "2023-05-15T05:00",
                "2023-05-15T06:00",
                "2023-05-15T07:00",
                "2023-05-15T08:00",
                "2023-05-15T09:00",
                "2023-05-15T10:00",
                "2023-05-15T11:00",
                "2023-05-15T12:00",
                "2023-05-15T13:00",
                "2023-05-15T14:00",
                "2023-05-15T15:00",
                "2023-05-15T16:00",
                "2023-05-15T17:00",
                "2023-05-15T18:00",
                "2023-05-15T19:00",
                "2023-05-15T20:00",
                "2023-05-15T21:00",
                "2023-05-15T22:00",
                "2023-05-15T23:00",
                "2023-05-16T00:00",
                "2023-05-16T01:00",
                "2023-05-16T02:00",
                "2023-05-16T03:00",
                "2023-05-16T04:00",
                "2023-05-16T05:00",
                "2023-05-16T06:00",
                "2023-05-16T07:00",
                "2023-05-16T08:00",
                "2023-05-16T09:00",
                "2023-05-16T10:00",
                "2023-05-16T11:00",
                "2023-05-16T12:00",
                "2023-05-16T13:00",
                "2023-05-16T14:00",
                "2023-05-16T15:00",
                "2023-05-16T16:00",
                "2023-05-16T17:00",
                "2023-05-16T18:00",
                "2023-05-16T19:00",
                "2023-05-16T20:00",
                "2023-05-16T21:00",
                "2023-05-16T22:00",
                "2023-05-16T23:00",
                "2023-05-17T00:00",
                "2023-05-17T01:00",
                "2023-05-17T02:00",
                "2023-05-17T03:00",
                "2023-05-17T04:00",
                "2023-05-17T05:00",
                "2023-05-17T06:00",
                "2023-05-17T07:00",
                "2023-05-17T08:00",
                "2023-05-17T09:00",
                "2023-05-17T10:00",
                "2023-05-17T11:00",
                "2023-05-17T12:00",
                "2023-05-17T13:00",
                "2023-05-17T14:00",
                "2023-05-17T15:00",
                "2023-05-17T16:00",
                "2023-05-17T17:00",
                "2023-05-17T18:00",
                "2023-05-17T19:00",
                "2023-05-17T20:00",
                "2023-05-17T21:00",
                "2023-05-17T22:00",
                "2023-05-17T23:00",
                "2023-05-18T00:00",
                "2023-05-18T01:00",
                "2023-05-18T02:00",
                "2023-05-18T03:00",
                "2023-05-18T04:00",
                "2023-05-18T05:00",
                "2023-05-18T06:00",
                "2023-05-18T07:00",
                "2023-05-18T08:00",
                "2023-05-18T09:00",
                "2023-05-18T10:00",
                "2023-05-18T11:00",
                "2023-05-18T12:00",
                "2023-05-18T13:00",
                "2023-05-18T14:00",
                "2023-05-18T15:00",
                "2023-05-18T16:00",
                "2023-05-18T17:00",
                "2023-05-18T18:00",
                "2023-05-18T19:00",
                "2023-05-18T20:00",
                "2023-05-18T21:00",
                "2023-05-18T22:00",
                "2023-05-18T23:00",
                "2023-05-19T00:00",
                "2023-05-19T01:00",
                "2023-05-19T02:00",
                "2023-05-19T03:00",
                "2023-05-19T04:00",
                "2023-05-19T05:00",
                "2023-05-19T06:00",
                "2023-05-19T07:00",
                "2023-05-19T08:00",
                "2023-05-19T09:00",
                "2023-05-19T10:00",
                "2023-05-19T11:00",
                "2023-05-19T12:00",
                "2023-05-19T13:00",
                "2023-05-19T14:00",
                "2023-05-19T15:00",
                "2023-05-19T16:00",
                "2023-05-19T17:00",
                "2023-05-19T18:00",
                "2023-05-19T19:00",
                "2023-05-19T20:00",
                "2023-05-19T21:00",
                "2023-05-19T22:00",
                "2023-05-19T23:00",
                "2023-05-20T00:00",
                "2023-05-20T01:00",
                "2023-05-20T02:00",
                "2023-05-20T03:00",
                "2023-05-20T04:00",
                "2023-05-20T05:00",
                "2023-05-20T06:00",
                "2023-05-20T07:00",
                "2023-05-20T08:00",
                "2023-05-20T09:00",
                "2023-05-20T10:00",
                "2023-05-20T11:00",
                "2023-05-20T12:00",
                "2023-05-20T13:00",
                "2023-05-20T14:00",
                "2023-05-20T15:00",
                "2023-05-20T16:00",
                "2023-05-20T17:00",
                "2023-05-20T18:00",
                "2023-05-20T19:00",
                "2023-05-20T20:00",
                "2023-05-20T21:00",
                "2023-05-20T22:00",
                "2023-05-20T23:00",
                "2023-05-21T00:00",
                "2023-05-21T01:00",
                "2023-05-21T02:00",
                "2023-05-21T03:00",
                "2023-05-21T04:00",
                "2023-05-21T05:00",
                "2023-05-21T06:00",
                "2023-05-21T07:00",
                "2023-05-21T08:00",
                "2023-05-21T09:00",
                "2023-05-21T10:00",
                "2023-05-21T11:00",
                "2023-05-21T12:00",
                "2023-05-21T13:00",
                "2023-05-21T14:00",
                "2023-05-21T15:00",
                "2023-05-21T16:00",
                "2023-05-21T17:00",
                "2023-05-21T18:00",
                "2023-05-21T19:00",
                "2023-05-21T20:00",
                "2023-05-21T21:00",
                "2023-05-21T22:00",
                "2023-05-21T23:00",
                "2023-05-22T00:00",
                "2023-05-22T01:00",
                "2023-05-22T02:00",
                "2023-05-22T03:00",
                "2023-05-22T04:00",
                "2023-05-22T05:00",
                "2023-05-22T06:00",
                "2023-05-22T07:00",
                "2023-05-22T08:00",
                "2023-05-22T09:00",
                "2023-05-22T10:00",
                "2023-05-22T11:00",
                "2023-05-22T12:00",
                "2023-05-22T13:00",
                "2023-05-22T14:00",
                "2023-05-22T15:00",
                "2023-05-22T16:00",
                "2023-05-22T17:00",
                "2023-05-22T18:00",
                "2023-05-22T19:00",
                "2023-05-22T20:00",
                "2023-05-22T21:00",
                "2023-05-22T22:00",
                "2023-05-22T23:00"
                ],
                "precipitation": [
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0.4,
                0.5,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.2,
                0.2,
                0,
                0,
                0,
                0,
                0,
                0,
                0.2,
                0.3,
                0.1,
                0,
                0,
                0,
                0.1,
                0,
                0,
                0.1,
                0.1,
                0,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0,
                0,
                0.1,
                0,
                0,
                0,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.2,
                0.4,
                0.3,
                0.3,
                0.3,
                0.3,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.3,
                0.3,
                0.6,
                0.5,
                0.2,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.2,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.3,
                0.5,
                0.3,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0.1,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0.1,
                0.1,
                0,
                0,
                0,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.2,
                1.1,
                1.7,
                1.1,
                0.6,
                0.2,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.2,
                0.2,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0.1,
                0,
                0,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0.1,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                0,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null,
                null
                ]
                },
                "daily_units": {
                "time": "iso8601",
                "sunrise": "iso8601"
                },
                "daily": {
                "time": [
                "2023-05-08",
                "2023-05-09",
                "2023-05-10",
                "2023-05-11",
                "2023-05-12",
                "2023-05-13",
                "2023-05-14",
                "2023-05-15",
                "2023-05-16",
                "2023-05-17",
                "2023-05-18",
                "2023-05-19",
                "2023-05-20",
                "2023-05-21",
                "2023-05-22"
                ],
                "sunrise": [
                "2023-05-08T07:29",
                "2023-05-09T07:30",
                "2023-05-10T07:32",
                "2023-05-11T07:33",
                "2023-05-12T07:35",
                "2023-05-13T07:37",
                "2023-05-14T07:38",
                "2023-05-15T07:40",
                "2023-05-16T07:41",
                "2023-05-17T07:43",
                "2023-05-18T07:44",
                "2023-05-19T07:45",
                "2023-05-20T07:47",
                "2023-05-21T07:48",
                "2023-05-22T07:50"
                ]
                }
                }""";
    }

}